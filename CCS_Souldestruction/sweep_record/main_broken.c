#include <usbstk5515.h>
#include <AIC_func.h>
#include <stdio.h>
#include <math.h>
#include <usbstk5515_interrupts.h>
//#include "cheby100N512.h"
#include <Dsplib.h>
#include "XVGA.h"
//#include "recordSweep.h"
//#include "FFT.h"

#define FOREVER 1
#define BLUE 2
#define PI 3.14159265

#define TABLE_SIZE  512

static const Int16 sinetable[TABLE_SIZE] = {
		0,  402,  804, 1206, 1608, 2009, 2410, 2811, 3212, 3612,
		4011, 4410, 4808, 5205, 5602, 5998, 6393, 6786, 7179, 7571,
		7962, 8351, 8739, 9126, 9512, 9896, 10278, 10659, 11039, 11417,
		11793, 12167, 12539, 12910, 13279, 13645, 14010, 14372, 14732,
		15090, 15446, 15800, 16151, 16499, 16846, 17189, 17530, 17869,
		18204, 18537, 18868, 19195, 19519, 19841, 20159, 20475, 20787,
		21096, 21403, 21705, 22005, 22301, 22594, 22884, 23170, 23452,
		23731, 24007, 24279, 24547, 24811, 25072, 25329, 25582, 25832,
		26077, 26319, 26556, 26790, 27019, 27245, 27466, 27683, 27896,
		28105, 28310, 28510, 28706, 28898, 29085, 29268, 29447, 29621,
		29791, 29956, 30117, 30273, 30424, 30571, 30714, 30852, 30985,
		31113, 31237, 31356, 31470, 31580, 31685, 31785, 31880, 31971,
		32057, 32137, 32213, 32285, 32351, 32412, 32469, 32521, 32567,
		32609, 32646, 32678, 32705, 32728, 32745, 32757, 32765, 32767,
		32765, 32757, 32745, 32728, 32705, 32678, 32646, 32609, 32567,
		32521, 32469, 32412, 32351, 32285, 32213, 32137, 32057, 31971,
		31880, 31785, 31685, 31580, 31470, 31356, 31237, 31113, 30985,
		30852, 30714, 30571, 30424, 30273, 30117, 29956, 29791, 29621,
		29447, 29268, 29085, 28898, 28706, 28510, 28310, 28105, 27896,
		27683, 27466, 27245, 27019, 26790, 26556, 26319, 26077, 25832,
		25582, 25329, 25072, 24811, 24547, 24279, 24007, 23731, 23452,
		23170, 22884, 22594, 22301, 22005, 21705, 21403, 21096, 20787,
		20475, 20159, 19841, 19519, 19195, 18868, 18537, 18204, 17869,
		17530, 17189, 16846, 16499, 16151, 15800, 15446, 15090, 14732,
		14372, 14010, 13645, 13279, 12910, 12539, 12167, 11793, 11417,
		11039, 10659, 10278, 9896, 9512, 9126, 8739, 8351, 7962, 7571,
		7179, 6786, 6393, 5998, 5602, 5205, 4808, 4410, 4011, 3612, 3212,
		2811, 2410, 2009, 1608, 1206,  804,  402,    0, -402, -804, -1206,
		-1608, -2009, -2410, -2811, -3212, -3612, -4011, -4410, -4808, -5205,
		-5602, -5998, -6393, -6786, -7179, -7571, -7962, -8351, -8739, -9126,
		-9512, -9896, -10278, -10659, -11039, -11417, -11793, -12167, -12539,
		-12910, -13279, -13645, -14010, -14372, -14732, -15090, -15446, -15800,
		-16151, -16499, -16846, -17189, -17530, -17869, -18204, -18537, -18868,
-19195, -19519, -19841, -20159, -20475, -20787, -21096, -21403, -21705, -22005,
-22301, -22594, -22884, -23170, -23452, -23731, -24007, -24279, -24547, -24811,
-25072, -25329, -25582, -25832, -26077, -26319, -26556, -26790, -27019, -27245,
-27466, -27683, -27896, -28105, -28310, -28510, -28706, -28898, -29085, -29268,
-29447, -29621, -29791, -29956, -30117, -30273, -30424, -30571, -30714, -30852,
-30985, -31113, -31237, -31356, -31470, -31580, -31685, -31785, -31880, -31971,
-32057, -32137, -32213, -32285, -32351, -32412, -32469, -32521, -32567, -32609,
-32646, -32678, -32705, -32728, -32745, -32757, -32765, -32767, -32765, -32757,
-32745, -32728, -32705, -32678, -32646, -32609, -32567, -32521, -32469, -32412,
-32351, -32285, -32213, -32137, -32057, -31971, -31880, -31785, -31685, -31580,
-31470, -31356, -31237, -31113, -30985, -30852, -30714, -30571, -30424, -30273,
-30117, -29956, -29791, -29621, -29447, -29268, -29085, -28898, -28706, -28510,
-28310, -28105, -27896, -27683, -27466, -27245, -27019, -26790, -26556, -26319,
-26077, -25832, -25582, -25329, -25072, -24811, -24547, -24279, -24007, -23731,
-23452, -23170, -22884, -22594, -22301, -22005, -21705, -21403, -21096, -20787,
-20475, -20159, -19841, -19519, -19195, -18868, -18537, -18204, -17869, -17530,
-17189, -16846, -16499, -16151, -15800, -15446, -15090, -14732, -14372, -14010,
-13645, -13279, -12910, -12539, -12167, -11793, -11417, -11039, -10659, -10278,
-9896, -9512, -9126, -8739, -8351, -7962, -7571, -7179, -6786, -6393, -5998, -5602,
-5205, -4808, -4410, -4011, -3612, -3212, -2811, -2410, -2009, -1608, -1206, -804, -402
};

void XVGAinit(Uint16);
void GoTo(Uint16 x, Uint16 y);
void Draw(Uint16 color, Uint16 x, Uint16 y);
void InitSpi(void);		// added
void InitSystem(void);	// added
void ConfigPort(void);	// added

//=======================
void recordSweep(Uint32 _min_freq, Uint32 _max_freq, Uint32 fs, Int16 *in);
//=======================


#define BUFSIZE 512
#define fs 48000UL

DATA *pOUT;//Pointers to Current buffers
DATA AMP;
void Reset();

interrupt void I2S_ISR(){
	asm("	nop"); // GOTCHA
	IFR0 &= (1 << I2S_BIT_POS);//Clear interrupt Flag
}




// Setup AIC interrupt routine.
void I2S_interrupt_setup(void)
{
	Uint32 reset_loc = (Uint32)Reset;
	IVPD = reset_loc >> 8;//pointer table points to Reset
	IVPH = reset_loc >> 8;//Ditto

	*((Uint32*)((reset_loc + I2S_ISR_OFFSET)>>1)) = (Uint32)I2S_ISR;

	SYS_EXBUSSEL |= (0x1 << 8);//Set the External bus select SP0Mode to I2S
	IER0 |= (1 << I2S_BIT_POS);//Set up the Global interrupt register to flag on I2S receive flag
	IFR0 &= (1 << I2S_BIT_POS);
}

Int16 sweepResult[16384];

void main(void)
{
	Uint32 i;
	Int16 POUT[1024];
	Int32 maxIndex, max;
	unsigned int start_switch = 1;

   	_disable_interrupts();
  	USBSTK5515_init();
  	AIC_init();
  	I2S_interrupt_setup();
  	InitSpi();

  	recordSweep(20, 20000, fs, sweepResult);

  	for(i=0; i<16384; ++i)
  	{
  		AIC_write2(sweepResult[i] ,sweepResult[i]);
  	}

  	initFFT(sweepResult, 0, pOUT);
  	processFFT();
	XVGAinit(start_switch);
    max = 0;
	maxIndex = 512;
    showFFT(&maxIndex, &max);
    start_switch = 0;

/*
  	//Do cfft with scaling.
	for (b=0; b < 16383; b = b+1)
	{
		in[b] = ((Int32)in[b]*(Int32)chebwin512[b]) >>15;
	}

	cfft_SCALE(in, BUFSIZE);
	cbrev(in, pOUT, BUFSIZE);


	unsigned int start_switch;
  	start_switch = 1;
	XVGAinit(start_switch);   // switch display page

	for (BUFCHK = 0; BUFCHK < BUFSIZE; BUFCHK = BUFCHK + 2)
				{
					tmp = ((Int32)pOUT[BUFCHK]*pOUT[BUFCHK]) + ((Int32)pOUT[BUFCHK+1] * pOUT[BUFCHK+1]);
					tmp2 = FFracSqrt(tmp);
					tmp2 = tmp2 >> 14;  // Should really be >>15.  Done for larger dynamic
					// range.  But now we need to check for overflow.
					AMP = tmp2>32767?32767:tmp2<-32768?-32768:tmp2; // amplitude of the output sine wave
					Reg[BUFCHK >> 1] = AMP;
					Draw(BLUE,100+BUFCHK/2, AMP >> 4 );
				}
	start_switch = 0; */

	while(1){}
}
